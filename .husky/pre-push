#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

set -u

echo "[pre-push] Quick repo audit (if available)…"
if [ -f scripts/repo-audit.sh ]; then
	bash scripts/repo-audit.sh | head -n 20 || {
		echo "[pre-push] Repo audit failed. Blocking push." >&2
		exit 1
	}
fi

if ! command -v npm >/dev/null 2>&1; then
	echo "[pre-push] npm not found in PATH. Blocking push." >&2
	exit 1
fi

echo "[pre-push] Running lint/tests…"
npm run -s prepush || {
	echo "[pre-push] Lint/tests failed. Blocking push." >&2
	exit 1
}

echo "[pre-push] Validating 5/3/1 program JSON…"
npm run -s programs:531 || {
	echo "[pre-push] 5/3/1 program validation failed. Fix JSON before pushing." >&2
	exit 1
}

echo "[pre-push] Generating 5/3/1 reports (non-blocking)…"
npm run -s report:531 || echo "[pre-push] Report generation failed (non-blocking)."

echo "[pre-push] All checks passed. Proceeding with push."
