<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Enhanced Fatigue Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üî• Enhanced Fatigue & MRV Detection - Quick Test</h1>
    
    <div class="test-section">
        <h2>Test: SFR ‚â§ 1 Trigger</h2>
        <button onclick="testSFRTrigger()">Test SFR Fatigue Detection</button>
        <div id="sfrTriggerTest" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test: 3% Strength Drop Trigger</h2>
        <button onclick="testStrengthDropTrigger()">Test Strength Drop Detection</button>
        <div id="strengthDropTest" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test: Early Deload (One Bad Week)</h2>
        <button onclick="testEarlyDeload()">Test One Week Deload</button>
        <div id="earlyDeloadTest" class="test-result"></div>
    </div>

    <script type="module">
        import trainingState from './js/core/trainingState.js';
        import { isHighFatigue } from './js/algorithms/fatigue.js';
        import { processWeeklyVolumeProgression } from './js/algorithms/volume.js';

        // Make available globally
        window.trainingState = trainingState;
        window.isHighFatigue = isHighFatigue;
        window.processWeeklyVolumeProgression = processWeeklyVolumeProgression;

        window.testSFRTrigger = function() {
            const output = document.getElementById('sfrTriggerTest');
            let results = [];
            
            try {
                results.push('=== SFR ‚â§ 1 Trigger Test ===\n');
                
                // High fatigue scenario: SFR = 2/7 = 0.29 ‚â§ 1
                const highFatigueFeedback = {
                    soreness: 3,      // High soreness
                    jointAche: 2,     // Moderate joint ache  
                    perfChange: -1,   // Performance drop (+2 penalty)
                    pump: 1,          // Low pump
                    disruption: 1,    // Low disruption
                    lastLoad: 100     // Same as baseline (no strength drop)
                };
                
                const fatigue = highFatigueFeedback.soreness + highFatigueFeedback.jointAche + (highFatigueFeedback.perfChange < 0 ? 2 : 0);
                const stimulus = highFatigueFeedback.pump + highFatigueFeedback.disruption;
                const SFR = stimulus / (fatigue || 1);
                
                results.push(`Fatigue Score: ${fatigue} (soreness:${highFatigueFeedback.soreness} + jointAche:${highFatigueFeedback.jointAche} + perfPenalty:2)`);
                results.push(`Stimulus Score: ${stimulus} (pump:${highFatigueFeedback.pump} + disruption:${highFatigueFeedback.disruption})`);
                results.push(`SFR: ${SFR.toFixed(2)}`);
                results.push(`SFR ‚â§ 1: ${SFR <= 1 ? 'üî¥ YES' : 'üü¢ NO'}`);
                
                // Test with isHighFatigue function
                trainingState.setBaselineStrength('Chest', 100);
                const highFatigueDetected = isHighFatigue('Chest', highFatigueFeedback, trainingState);
                
                results.push(`\nHigh Fatigue Detected: ${highFatigueDetected ? 'üî¥ YES' : 'üü¢ NO'}`);
                results.push(`Expected: YES - ${highFatigueDetected === true ? '‚úÖ PASS' : '‚ùå FAIL'}`);
                
                output.innerHTML = results.join('<br>');
                output.className = 'test-result ' + (highFatigueDetected === true ? 'pass' : 'fail');
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'test-result fail';
            }
        };

        window.testStrengthDropTrigger = function() {
            const output = document.getElementById('strengthDropTest');
            let results = [];
            
            try {
                results.push('=== 3% Strength Drop Trigger Test ===\n');
                
                // Set baseline strength
                trainingState.setBaselineStrength('Chest', 100);
                
                // Strength drop scenario: 95kg < 97% of 100kg (97kg)
                const strengthDropFeedback = {
                    soreness: 1,      // Low soreness
                    jointAche: 0,     // No joint ache
                    perfChange: 0,    // Same performance
                    pump: 2,          // Good pump
                    disruption: 2,    // Good disruption
                    lastLoad: 95      // 5% drop from baseline
                };
                
                const baseline = trainingState.baselineStrength['Chest'];
                const dropPercent = ((baseline - strengthDropFeedback.lastLoad) / baseline) * 100;
                const strengthDrop = trainingState.repStrengthDrop('Chest', strengthDropFeedback.lastLoad);
                
                results.push(`Baseline Strength: ${baseline}kg`);
                results.push(`Last Load: ${strengthDropFeedback.lastLoad}kg`);
                results.push(`Drop Percentage: ${dropPercent.toFixed(1)}%`);
                results.push(`Threshold: 3% (97% of baseline = ${(baseline * 0.97).toFixed(1)}kg)`);
                results.push(`Strength Drop Detected: ${strengthDrop ? 'üî¥ YES' : 'üü¢ NO'}`);
                
                // Test with isHighFatigue function
                const highFatigueDetected = isHighFatigue('Chest', strengthDropFeedback, trainingState);
                
                results.push(`\nHigh Fatigue Detected: ${highFatigueDetected ? 'üî¥ YES' : 'üü¢ NO'}`);
                results.push(`Expected: YES - ${highFatigueDetected === true ? '‚úÖ PASS' : '‚ùå FAIL'}`);
                
                output.innerHTML = results.join('<br>');
                output.className = 'test-result ' + (highFatigueDetected === true ? 'pass' : 'fail');
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'test-result fail';
            }
        };

        window.testEarlyDeload = function() {
            const output = document.getElementById('earlyDeloadTest');
            let results = [];
            
            try {
                results.push('=== Early Deload (One Bad Week) Test ===\n');
                
                // Reset training state to week 1
                trainingState.weekNo = 1;
                trainingState.consecutiveMRVWeeks = 0;
                trainingState.totalMusclesNeedingRecovery = 0;
                trainingState.setBaselineStrength('Chest', 100);
                trainingState.currentWeekSets['Chest'] = trainingState.volumeLandmarks['Chest'].MEV;
                
                results.push(`Week: ${trainingState.weekNo}`);
                results.push(`Chest Sets: ${trainingState.currentWeekSets['Chest']} (MEV: ${trainingState.volumeLandmarks['Chest'].MEV})`);
                results.push(`Should Deload (before): ${trainingState.shouldDeload()}`);
                
                // Simulate high fatigue feedback that should trigger early deload
                const highFatigueFeedback = {
                    'Chest': {
                        soreness: 3,
                        jointAche: 2,
                        perfChange: -1,
                        pump: 1,
                        disruption: 1,
                        lastLoad: 95,
                        stimulus: 2
                    }
                };
                
                // Process the feedback
                const result = processWeeklyVolumeProgression(highFatigueFeedback, trainingState);
                
                results.push(`\nAfter processing high fatigue feedback:`);
                results.push(`  MRV Hits: ${result.mrvHits}`);
                results.push(`  Deload Triggered: ${result.deloadTriggered ? 'üî¥ YES' : 'üü¢ NO'}`);
                results.push(`  Should Deload (after): ${trainingState.shouldDeload()}`);
                
                // Check if early deload was triggered
                const earlyDeloadSuccess = result.deloadTriggered && trainingState.weekNo === 1;
                results.push(`\nüéØ Early Deload Test: ${earlyDeloadSuccess ? '‚úÖ PASS - Deload fired after ONE bad week' : '‚ùå FAIL - Should have triggered deload'}`);
                
                output.innerHTML = results.join('<br>');
                output.className = 'test-result ' + (earlyDeloadSuccess ? 'pass' : 'fail');
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'test-result fail';
            }
        };
    </script>
</body>
</html>
